# Binary Translation 正式验证工具

## 简介

这个工具用于验证 AMD64 (x86_64) 和 AArch64 (ARM64) 汇编代码之间的等价性。它采用了符号执行和启发式验证相结合的方法，能够有效地分析和比较不同架构的汇编指令序列，确定它们是否在语义上等价。

## 主要功能

- **精确验证模式**：使用符号执行技术精确验证单条指令的等价性
- **启发式验证模式**：对于复杂指令序列或特殊指令，使用启发式方法判断等价性
- **综合验证模式**：结合精确和启发式方法，对多条指令序列进行分析
- **批量验证**：支持从规则文件中批量读取和验证指令对
- **交互式验证**：支持用户交互式输入指令对进行验证
- **统计结果**：提供详细的验证结果统计，包括等价和不等价指令的数量和比例

## 安装依赖

本工具依赖以下Python库：

```bash
pip install angr claripy capstone keystone-engine
```

## 使用方法

### 命令行运行

```bash
python combined_verify.py
```

### 验证模式

程序启动后，可以选择两种验证模式：

1. **规则文件验证**：验证预先定义的规则文件中的代码对
2. **交互式输入验证**：手动输入x86和ARM代码进行验证

### 规则文件格式

规则文件应遵循以下格式：

```
1.Guest:
[ARM汇编代码]
1.Host:
[x86汇编代码]
2.Guest:
[ARM汇编代码]
2.Host:
[x86汇编代码]
...
```

其中每个规则以数字编号开头，Guest表示ARM代码，Host表示x86代码。

### 交互式模式命令

在交互式模式下，可以使用以下命令：

- `exit` - 退出程序
- `stats` - 查看当前验证统计结果

## 验证工作原理

1. **预处理**：对汇编代码进行预处理，处理寄存器名称、内存访问格式等
2. **符号执行**：使用angr和claripy库进行符号执行，分析指令的效果
3. **对应分析**：建立两种架构之间的寄存器和内存访问映射关系
4. **等价判断**：比较两种架构下指令执行后状态的变化是否一致

## 示例

验证两条简单指令是否等价：

```
x86汇编代码:
mov rax, 0x42

ARM汇编代码:
mov x4, 0x42
```

验证结果将显示这两条指令是等价的，因为根据寄存器映射关系，rax对应x4，且两条指令都将寄存器设置为相同的值0x42。

## 注意事项

- 支持处理ARM汇编中的.x后缀
- 可以处理不同位宽寄存器之间的映射
- 对于无法直接验证的特殊指令（如函数调用），会使用启发式方法进行判断
- 验证结果统计会显示等价和不等价指令的数量和编号 




### 2. 交互式验证

使用交互式验证工具，可以逐对输入和验证汇编代码：

```bash
python3 formal_verify/verify_asm.py
```

工具将提示您输入x86和ARM汇编代码，并实时显示验证结果。

### 3. Guest-Host验证工具 (新功能)

新增的验证工具支持Guest(ARM)和Host(x86)代码对验证，可以处理以reg0、reg1等通用形式表示的寄存器：

```bash
python3 formal_verify/verify_arm_x86.py
```

该工具支持两种模式：
- **规则文件验证模式**：解析包含多个规则的文件
- **交互式输入验证模式**：手动输入ARM和x86汇编代码

规则文件的格式示例：
```
1.Guest:
    mov reg0, reg1
    lsr reg0, reg0, #imm0
    add reg2, reg0, #imm1
1.Host:
    mov reg0, reg1
    shr reg0, $imm0
    lea reg2, qword [reg0 + imm1]
```

对于含有函数调用（如`call $Label`和`set_call #Label`）的指令，工具会假设它们是等效的，跳过验证。

## 寄存器映射

工具使用以下寄存器映射关系进行验证：

| x86寄存器 | ARM寄存器 |
|----------|-----------|
| rax      | x4        |
| rcx      | x5        |
| rdx      | x6        |
| rbx      | x7        |
| rsp      | x8        |
| rbp      | x9        |
| rsi      | x10       |
| rdi      | x11       |
| r8       | x12       |
| r9       | x13       |
| r10      | x14       |
| r11      | x15       |
| r12      | x16       |
| r13      | x17       |
| r14      | x19       |
| r15      | fp(x29)   |

32位、16位和8位寄存器也有相应的映射。

新工具还支持通用reg0/reg1格式的动态寄存器映射。

## 限制

当前工具有以下限制：

1. 不支持带有标签和分支的复杂汇编代码
2. 对于函数调用的验证，工具会假设它们是等效的
3. 对于具有多个执行路径的代码，验证结果可能不准确